# PDF OCR 自动化处理工具使用说明

## 简介

本工具基于 Python 开发，结合本地部署的 Umi-OCR 服务，能够自动批量处理 PDF 文件，将其转换为带格式的 Markdown 文档。工具具有以下特点：

1. **离线处理**：使用本地 OCR 服务，保护隐私且无次数限制
2. **批量处理**：可一次性处理文件夹内所有 PDF 文件
3. **结构化输出**：生成的 Markdown 文件按页分割，便于阅读和后续处理
4. **并发加速**：支持多线程处理，提高处理效率
5. **错误处理**：具备完善的异常处理机制
6. **智能文件管理**：自动创建输入输出目录，避免重复处理
7. **服务验证**：启动时自动验证OCR服务可用性
8. **智能命名**：根据文件名中的日期自动重命名输出文件

## 环境要求

- Python 3.6+
- 依赖库：pymupdf, requests
- Umi-OCR 服务（需本地部署并启动）

## 安装步骤

1. 安装 Python（建议 3.7 以上版本）
2. 安装依赖库：
   ```bash
   pip install pymupdf requests
   ```
3. 下载并安装 Umi-OCR：
   - 访问 Umi-OCR GitHub 项目页面下载最新版本
   - 启动软件并确保 HTTP 接口已开启（默认端口 1234）

## 使用方法

1. 修改脚本配置：
   打开 `pdf_ocr_worker.py` 文件，修改以下配置项：
   ```python
   # ================= 配置区域 =================
   # 1. 你的 PDF 文件夹路径
   INPUT_FOLDER = r"C:\Users\YourName\Documents\PDFs"
   # 2. 转换后的 MD 文件保存路径
   OUTPUT_FOLDER = r"C:\Users\YourName\Documents\MDs"
   # 3. Umi-OCR 的本地接口地址
   OCR_API_URL = "http://127.0.0.1:1234/api/ocr"
   # 4. 并发处理的线程数
   MAX_WORKERS = 3
   # 5. 图片放大倍数（提高OCR识别准确率）
   IMAGE_SCALE = 2.0
   # 6. 服务验证图片路径
   SERVICE_TEST_IMAGE = r"C:\Users\YourName\Documents\test_service.png"
   # ===========================================
   ```

2. 准备待处理的 PDF 文件：
   将所有需要处理的 PDF 文件放入 INPUT_FOLDER 指定的文件夹中

3. 运行脚本：
   - 方法一（推荐）：双击运行 `run_ocr.bat` 批处理文件
   - 方法二：在命令行中执行 `python pdf_ocr_worker.py`

4. 查看结果：
   处理完成后，Markdown 文件将保存在 OUTPUT_FOLDER 指定的文件夹中

## 核心功能

### 1. 输入输出目录管理
- 自动创建输入目录 (`input_pdfs`) 和输出目录 (`output_md`)
- 将待处理的PDF文件放入 `input_pdfs` 目录

### 2. 智能处理避免重复
- 自动检查输出目录中是否已存在同名且非空的MD文件
- 若存在则跳过处理，避免重复工作

### 3. 服务可用性验证
- 启动时自动测试OCR服务是否正常工作
- 若服务不可用则及时报错并退出

### 4. 智能文件命名
- 自动从文件名中提取日期信息（如251019 → 2025-10-19）
- 如果文件名中没有日期，则从文档内容的前几行中提取日期
  - 支持格式："2025年10月16日" 或 "25年10月23日"
- 按日期重新组织文件名，便于排序和查找

## 输出格式

生成的 Markdown 文件具有以下结构：
```markdown
# PDF文件名.pdf

连续的OCR识别内容，智能连接跨页文本...

（不再有页面分隔符，文本根据语义智能连接）
```

对于跨页的文本内容，脚本会智能判断是否需要连接：
- 如果当前页末尾不是句号等结束符号，会将下一页的内容直接连接
- 如果当前页末尾是句号等结束符号，会自动换行另起一段
- 智能处理空格添加，确保中文和英文内容的连接自然

## 注意事项

1. 确保 Umi-OCR 服务在脚本运行前已启动
2. 对于图像质量较差的 PDF，可通过调整 IMAGE_SCALE 参数提高识别准确率
3. 如果处理大量文件，建议适当降低 MAX_WORKERS 参数以避免系统资源占用过高
4. 脚本会自动跳过已处理的文件，避免重复处理
5. 智能文件命名功能适用于包含6位数字日期（YYMMDD格式）的文件名

## 故障排除

1. **连接失败**：检查 Umi-OCR 是否已启动，端口是否正确
2. **识别准确率低**：尝试增大 IMAGE_SCALE 参数值
3. **处理速度慢**：可适当增加 MAX_WORKERS 参数值
4. **内存不足**：处理大型 PDF 时可能出现此问题，建议减少并发数
5. **服务验证失败**：检查 SERVICE_TEST_IMAGE 路径是否正确，图片是否有效

## 技术支持

如有问题，请提交 issue 或联系开发者。